# 🎯 Censys UDPXY 提取器 - 完整使用指南

## 📝 项目概述

这是一个专为 Censys 平台设计的 Chrome 浏览器扩展，采用多模式架构，支持自动化提取 UDPXY 相关主机的 IP、端口等信息。通过在已登录的浏览器环境中运行，完全绕过 Cloudflare 和反自动化检测，适用于 IPTV/流媒体安全研究和数据收集。新增的批量IP获取功能实现了真正的一键自动化数据收集，大幅提升工作效率。

## ✨ 主要特性

- **🔍 智能IP提取**: 从搜索结果自动识别和提取所有主机 IP 地址
- **🔌 端口数据提取**: 自动识别HTTP/HTTPS协议端口并生成CSV文件
- **🤖 多模式架构**: 搜索页面模式和主机详情页面模式，界面自适应切换
- **📊 多格式导出**: 支持 IP列表TXT、端口数据CSV、主机详情CSV 多种格式输出
- **🛡️ 反检测设计**: 在真实浏览器环境中运行，绕过所有检测机制
- **📈 实时统计**: 页面浮动按钮和插件界面均显示提取进度和结果统计
- **💾 数据持久化**: 本地缓存所有数据，关闭浏览器后不会丢失
- **🚀 自动收集**: 主机详情页支持自动收集模式，批量访问时自动保存数据
- **🔥 批量IP获取**: 一键批量获取已保存IP列表的详细主机信息，支持暂停/恢复
- **⚡ 智能限速**: 内置2秒间隔防止API限制，自动处理403/429/404错误

## 🛠️ 安装指南

### 1. 克隆或下载项目
```bash
git clone <repository_url>
cd censys-plugin
```

### 2. 在 Chrome 中加载扩展

#### 安装步骤：
1. **打开 Chrome 扩展管理页面**
   - 在地址栏输入: `chrome://extensions/`
   - 或通过菜单: **更多工具** → **扩展程序**

2. **启用开发者模式**
   - 点击右上角的 **开发者模式** 开关
   - 确保开关为蓝色(开启状态)

3. **加载扩展**
   - 点击 **加载已解压的扩展程序** 按钮
   - 选择 `censys-plugin` 文件夹
   - 点击 **选择文件夹**

4. **验证安装**
   - 扩展列表中应显示 **Censys UDPXY 提取器**
   - 状态应为 **已启用**
   - 浏览器工具栏出现蓝紫色渐变圆形图标

## 🎯 使用指南

### 准备工作
1. 访问 https://platform.censys.io
2. 使用你的账户正常登录
3. 确保可以正常访问搜索功能

### 🔍 推荐搜索语句
```
(host.services.software.product = "udpxy" or web.software.product = "udpxy") and host.location.country = "China"
```

### 📊 多模式功能详解

#### 模式一：搜索页面模式 🔍
- **适用页面**: https://platform.censys.io/search?q=...
- **页面识别**: 扩展自动检测搜索页面，右上角显示操作按钮
- **功能特性**:
  
  **IP列表提取**:
  1. 在 Censys 搜索页面执行搜索
  2. 点击页面右上角 **📋 提取IP列表** 按钮（或插件界面按钮）
  3. 自动从搜索结果提取所有主机IP地址
  4. 支持去重合并，可下载TXT格式文件
  
  **端口数据提取**:
  1. 在搜索结果页面点击 **🔌 提取端口数据** 按钮
  2. 自动识别每个主机的HTTP/HTTPS协议端口
  3. 生成CSV文件，格式为 `ip,ports`（多个端口用|分隔）
  4. 自动下载，文件名包含时间戳

#### 模式二：主机详情页面模式 🖥️
- **适用页面**: https://platform.censys.io/hosts/x.x.x.x
- **页面识别**: 扩展自动检测主机详情页，显示浮动操作面板
- **功能特性**:

  **自动收集模式**:
  1. 点击右上角状态指示器或插件界面 **🤖 自动收集模式** 按钮
  2. 启用后状态显示为 **🟢 自动收集已启用**
  3. 访问任意主机详情页面，3秒后自动收集数据
  4. 显示成功通知并更新统计数字
  
  **手动收集模式**:
  1. 在主机详情页点击 **📊 收集数据** 按钮
  2. 立即收集当前主机的完整信息
  3. 包括端口、地理位置、ISP、DNS等信息

### 🎨 页面UI元素

#### 搜索页面浮动按钮
- **位置**: 页面右上角
- **📋 提取IP列表**: 绿色渐变按钮，提取当前页面所有IP
- **🔌 提取端口数据**: 橙色渐变按钮，提取HTTP/HTTPS端口数据

#### 主机详情页面浮动面板
- **状态指示器**: 显示自动收集开关状态，可点击切换
- **📊 收集数据**: 蓝色按钮，手动收集当前主机数据
- **统计显示**: 实时显示已收集的主机数量

### 🚀 自动化工作流程

#### 批量数据收集推荐流程
1. **搜索阶段**: 在搜索页面使用 **🔌 提取端口数据** 获取IP和端口概览
2. **启用自动收集**: 在任一主机详情页启用自动收集模式
3. **批量访问**: 通过书签或脚本批量打开主机详情页
4. **自动保存**: 扩展自动收集每个页面的详细数据
5. **数据导出**: 在插件界面导出完整的CSV数据文件

## 📊 数据格式说明

### IP列表文件 (txt格式)
```
203.x.x.10
118.x.x.33
203.x.x.251
```

### 端口数据文件 (csv格式)
包含字段：ip, ports (多个端口用|分隔)
```csv
ip,ports
203.x.x.10,"80|446|8081|8082|8090|9000"
118.x.x.33,"80|8080"
203.x.x.251,"443|8443"
```

### 主机详情文件 (csv格式)
包含字段：ip, port, url, dns, country, city, province, isp
```csv
ip,port,url,dns,country,city,province,isp
203.x.x.10,8088,http://203.x.x.10:8088,example.com,China,Wuhan,Hubei,China Telecom
```

## 🔧 故障排除

### ❌ 常见错误及解决方案

#### 1. "Could not establish connection. Receiving end does not exist."
这是最常见的错误，表示内容脚本没有正确加载或通信失败。

**解决步骤：**

1. **检查页面URL**
   - ✅ 确保在正确的Censys页面：`https://platform.censys.io/*`
   - ❌ 不要在 `censys.com` 主页或其他子域使用

2. **重新加载扩展**
   1. 打开 `chrome://extensions/`
   2. 找到 "Censys UDPXY Extractor"
   3. 点击 🔄 刷新按钮
   4. 确保扩展状态为 **已启用**

3. **刷新Censys页面**
   1. 在Censys页面按 `F5` 或 `Ctrl+R`
   2. 等待页面完全加载
   3. 重新尝试扩展功能

4. **检查开发者工具**
   1. 在Censys页面按 `F12` 打开开发者工具
   2. 切换到 **Console** 标签
   3. 查找 `[Censys Extractor]` 开头的日志
   4. 如果没有日志，说明内容脚本未加载

#### 2. "Please navigate to Censys search page first"
**解决方案：**
- ❌ 错误URL示例：`https://censys.com/`, `https://censys.io/`
- ✅ 正确URL示例：`https://platform.censys.io/search`, `https://platform.censys.io/hosts/`

#### 3. 扩展图标点击无反应
**检查清单：**
- [ ] 扩展是否正确安装？
- [ ] 开发者模式是否启用？
- [ ] 是否在支持的网站？

#### 4. 自动收集不工作
**解决方案：**
1. 确认自动收集模式已启用（绿色状态）
2. 确保在正确的主机详情页面
3. 等待页面完全加载（约3秒）
4. 检查控制台是否有错误信息

#### 5. 数据提取不完整
**解决方案：**
1. 确保网络连接稳定
2. 避免在页面加载期间操作
3. 如果遇到验证码，手动通过后继续
4. 检查Censys账户是否有访问限制

#### 6. 批量获取功能不工作
**解决方案：**
1. 确保已有保存的IP列表（先执行提取IP操作）
2. 检查网络连接是否稳定
3. 如遇到API限制（403/429错误），等待几分钟后继续
4. 检查Censys账户登录状态

#### 7. API限制错误（403/429）
**解决方案：**
1. 这是正常的API速率限制，不是错误
2. 点击"暂停获取"停止当前操作
3. 等待5-10分钟让API限制重置
4. 点击"继续获取"恢复批量操作
5. 如果频繁出现，可以手动增加请求间隔时间

## 🎯 使用技巧

### 批量处理建议
1. **先收集概览**: 使用搜索页面的端口提取功能快速获取IP和端口概览
2. **启用自动收集**: 在主机详情页启用自动收集模式
3. **批量访问**: 通过书签或脚本批量打开主机详情页
4. **定期导出**: 避免数据丢失，定期导出CSV文件

### 性能优化
1. **控制并发**: 避免同时打开过多标签页
2. **清理缓存**: 定期清空扩展缓存释放内存
3. **分批处理**: 大量数据分批次处理，避免浏览器卡顿

### 安全建议
1. **合规使用**: 遵守Censys服务条款
2. **适度频率**: 避免过于频繁的请求
3. **账户安全**: 定期检查账户登录状态

## 🔍 技术实现

### 架构设计
- **popup.js**: 插件弹窗界面，负责用户交互和状态管理
- **content.js**: 内容脚本，负责页面数据提取和DOM操作
- **background.js**: 后台脚本，负责扩展生命周期和消息监听

### 数据提取机制
- **JSON解析**: 支持多种Censys平台JSON数据格式
- **DOM解析**: 从页面元素和链接中提取IP信息
- **协议过滤**: 精确匹配HTTP/HTTPS协议端口
- **递归搜索**: 深度遍历JSON对象结构

### 批量获取机制
- **状态管理**: 使用batchFetchState全局状态管理批量获取进程
- **API调用**: 通过fetch调用Censys hosts API获取主机详情
- **智能限速**: setTimeout实现2秒间隔，避免API速率限制
- **错误恢复**: 检测403/429/404状态码自动暂停，支持手动恢复
- **进度追踪**: 实时更新已处理/总数的进度显示

### 数据存储
- **本地缓存**: 使用Chrome存储API本地保存数据
- **持久化**: 关闭浏览器后数据不丢失
- **去重处理**: 自动去除重复IP和端口

## 📞 技术支持

如果遇到问题，请：
1. 检查本故障排除指南
2. 查看浏览器控制台错误信息
3. 确认扩展版本和浏览器版本
4. 提供详细的错误描述和复现步骤

## 🎯 适用场景

- **IPTV/流媒体安全研究**: 批量收集UDPXY服务器信息
- **资产发现与分析**: 自动化网络资产收集
- **安全研究**: 大规模主机数据分析
- **合规性检查**: 网络服务暴露面评估
- **批量数据采集**: 使用批量IP获取功能快速收集大量主机详情
- **API效率优化**: 利用智能限速避免手动访问每个主机页面

---

**项目主页**: https://github.com/vitter/iptv-sources  
**问题反馈**: https://github.com/vitter/iptv-sources/issues

## 📋 版本历史

### v1.6.0 - 批量IP获取功能 (2025-08-23)

#### ✨ 新增功能
- **🔥 批量IP获取**: 一键批量获取已保存IP列表的详细主机信息
- **智能暂停/恢复**: 支持批量获取过程中的暂停和恢复操作
- **API限制处理**: 自动检测403/429/404错误并暂停，可手动恢复
- **进度追踪**: 实时显示批量获取进度 "获取中... (当前/总数)"
- **智能限速**: 内置2秒请求间隔，避免触发API速率限制

#### 🔧 改进
- **错误恢复机制**: 优雅处理API限制，避免账户封禁
- **用户体验**: 清晰的状态提示和操作按钮
- **数据完整性**: 确保所有IP都能被正确处理

### v1.5.0 - 搜索页面自动收集功能 (2025-08-22)

#### ✨ 新增功能
- **搜索页面自动收集**: 搜索页面现在支持自动收集端口数据
- **搜索结果缓存**: 独立的搜索缓存系统，保留最近10次搜索结果
- **搜索页面CSV导出**: 可以直接导出搜索结果为CSV文件
- **统计显示**: 显示已缓存的搜索次数和记录总数

#### 🔧 改进
- **统一用户体验**: 搜索页面和主机详情页面功能一致
- **状态指示器**: 添加自动收集启用/禁用状态显示
- **错误处理**: 改进扩展上下文失效时的处理方式

### v1.4.0 - 分页支持和UDPXY识别修复

#### 🐛 修复
- **分页问题**: 修复搜索页面只获取10条记录问题，现在可获取全部结果
- **UDPXY误判**: 修复HTTP端口被错误标识为UDPXY端口的问题
- **API分页**: 正确处理Censys API分页请求

#### 🔧 改进
- **UDPXY识别**: 使用vendor/product字段精确识别UDPXY服务
- **数据完整性**: 确保获取所有可用的搜索结果

### v1.3.0 - API集成和端口提取功能

#### ✨ 新增功能
- **端口提取**: 从搜索页面和主机详情页面提取端口信息
- **CSV导出**: 生成IP和端口的CSV文件
- **Censys API集成**: 通过API获取详细的主机端口信息
- **自动收集**: 主机详情页面自动收集端口数据

### v1.2.0 - 文档优化

#### 📚 文档改进
- **文档合并**: 将多个分散的MD文件合并优化
- **安装指南**: 详细的Chrome扩展安装步骤
- **使用说明**: 完整的功能使用方法

### v1.1.0 - 端口范围扩展

#### 🔧 改进
- **censys.py**: 端口扫描范围从1000-65535扩展为1-65535
- **全端口覆盖**: 确保不遗漏任何可能的UDPXY端口

---

**项目主页**: https://github.com/vitter/iptv-sources  
**问题反馈**: https://github.com/vitter/iptv-sources/issues
