# IPTV直播源处理工具

一个功能完整的IPTV直播源下载、合并、测速与分组工具，用于从多个URL下载直播源，进行速度测试并重新分组输出。

## 🚀 功能特性

- **多源下载**: 从19个不同的直播源URL下载频道列表
- **智能合并**: 自动合并所有频道并去除重复项
- **速度测试**: 支持M3U8和直接流媒体的速度测试
- **智能分组**: 按央视、卫视、省级、港澳台、市级、其他进行自动分类
- **多格式输出**: 生成M3U和TXT两种格式的播放列表
- **日志记录**: 详细的下载和测速日志记录
- **超时控制**: 优化的超时机制，避免长时间卡死

## 📦 安装要求

### Python环境
- Python 3.6+
- requests库

### 安装依赖
```bash
pip install requests
```

## 🎯 使用方法

### 基本用法
```bash
# 每个频道最多保留速度最快的前20个URL源（默认）
python unicast.py

# 每个频道最多保留速度最快的前50个URL源
python unicast.py --top 50

# 每个频道最多保留速度最快的前10个URL源
python unicast.py --top 10
```

### 命令行参数
- `--top N`: 每个频道最多保留速度最快的前N个URL源（默认：20）

## 📂 输出文件

程序运行完成后会生成以下文件：

### 输出目录 (`output/`)
- **`unicast_result.m3u`**: M3U格式播放列表，每个URL单独一个条目
- **`unicast_result.txt`**: TXT格式播放列表，每个URL单独一行

### 日志文件
- **`txt.tmp`**: 汇总临时文件，包含所有下载的原始数据
- **`speed.log`**: 详细的测速日志，记录每个频道的测试结果

### 下载目录 (`downloads/`)
- 存放从各个源下载的原始文件

## 🏷️ 频道分组

程序会自动将频道分为以下6个组：

1. **央视频道**: CCTV系列、CGTN等
2. **卫视频道**: 各省卫视频道
3. **省级频道**: 各省地方频道
4. **港澳台频道**: 香港、澳门、台湾频道
5. **市级频道**: 各市地方频道
6. **其它频道**: 未分类的其他频道

## 📋 输出格式示例

### TXT格式样例
```txt
央视频道,#genre#
CCTV1,http://fast1.com/cctv1.m3u8
CCTV1,http://fast2.com/cctv1.m3u8
CCTV1,http://fast3.com/cctv1.m3u8
CCTV2,http://fast1.com/cctv2.m3u8
CCTV2,http://fast2.com/cctv2.m3u8

卫视频道,#genre#
安徽卫视,http://fast1.com/anhui.m3u8
安徽卫视,http://fast2.com/anhui.m3u8
北京卫视,http://fast1.com/beijing.m3u8
```

### M3U格式样例
```m3u
#EXTM3U
#EXTINF:-1 group-title="央视频道",CCTV1
http://fast1.com/cctv1.m3u8
#EXTINF:-1 group-title="央视频道",CCTV1
http://fast2.com/cctv1.m3u8
#EXTINF:-1 group-title="央视频道",CCTV1
http://fast3.com/cctv1.m3u8
#EXTINF:-1 group-title="卫视频道",安徽卫视
http://fast1.com/anhui.m3u8
```

### 格式特点
- **TXT格式**: 每个频道的每个URL单独占一行，格式为 `频道名,URL`
- **M3U格式**: 每个URL单独一个条目，不显示速度信息，便于播放器导入
- **排序规则**: 在每个分组内，频道按字母顺序排列，同一频道的多个URL按速度从快到慢排序

## 🎨 数据源

程序从以下19个优质源获取数据：
- live.zbds.org (5个源)
- chinaiptv.pages.dev (12个省份源)
- mycode.zhoujie218.top (1个源)
- 其他优质源 (13个源)

涵盖全国各省市的移动网络直播源。

## ⚡ 性能优化

### 测速优化
- **并发控制**: 3个线程并发测试，避免网络拥堵
- **超时机制**: 每个频道最多12秒超时，单次测试最多8秒
- **数据量控制**: M3U8测试2MB，直接流测试2MB
- **快速失败**: 连接超时5秒，数据下载超时5秒

### 网络优化
- 支持M3U8/HLS协议的专门处理
- 智能识别TS分片进行实际速度测试
- 优化的请求头和会话管理

## 📊 运行示例

```bash
$ python unicast.py --top 5
=== IPTV直播源处理工具 ===
开始下载直播源文件...
✓ 下载成功: tv_yd.txt
✓ 下载成功: anhui_mobile.txt
✓ 下载成功: fujian_mobile.txt
...
下载完成，共获得 19 个文件

解析直播源文件...
✓ 解析 tv_yd.txt: 获得 245 个频道
✓ 解析 anhui_mobile.txt: 获得 156 个频道
...
总共解析出 2044 个频道

去重后剩余 1865 个频道

开始测速 1865 个频道...
[1/1865] CCTV1: 9.89 MB/s
[2/1865] CCTV1: 7.17 MB/s
[3/1865] CCTV1: 测试失败
[4/1865] CCTV2: 8.34 MB/s
...
测速完成，有效频道: 892

为每个频道选择速度最快的前 5 个URL源...
  CCTV1: 从 15 个源中保留前 5 个
  CCTV2: 保留全部 3 个源
  湖南卫视: 从 12 个源中保留前 5 个
  安徽卫视: 保留全部 4 个源
...

处理后总共保留 456 个频道源

生成M3U文件: output/unicast_result.m3u
M3U文件已生成，包含以下分组:
  央视频道: 89 个频道源
  卫视频道: 156 个频道源
  省级频道: 78 个频道源
  港澳台频道: 34 个频道源
  市级频道: 67 个频道源
  其它频道: 32 个频道源

生成TXT文件: output/unicast_result.txt

=== 处理完成 ===
输出文件:
  M3U格式: output/unicast_result.m3u  
  TXT格式: output/unicast_result.txt
```

## 🔧 高级配置

### 调整保留URL数量
`--top` 参数控制每个频道最多保留的URL数量：
- 如果某个频道有10个URL源，使用 `--top 3` 则只保留速度最快的3个
- 如果某个频道只有2个URL源，使用 `--top 5` 则保留全部2个
- 推荐值：3-10，既保证质量又有备用源

### 自定义数据源
可以修改 `URLS` 列表来添加或替换数据源：

```python
URLS = [
    "https://your-custom-source.com/channels.txt",
    # 添加更多源...
]
```

### 调整分组规则
可以修改分组关键字来自定义频道分类：

```python
# 在 UnicastProcessor 类中修改
locals = ("北京", "天津", ...)  # 省级频道关键字
citys = ("石家庄", "唐山", ...)  # 市级频道关键字
hkmotw = ("凤凰", "香港", ...)  # 港澳台关键字
```

## 🐛 故障排除

### 常见问题

1. **下载失败**
   - 检查网络连接
   - 某些源可能临时不可用，属正常现象

2. **测速很慢**
   - 程序已优化，每个频道最多12秒超时
   - 可以使用较小的 `--top` 参数值来减少总输出数量

4. **没有生成输出文件**
   - 检查是否有有效的频道通过测速
   - 查看 `speed.log` 了解详细测速情况

## 💡 使用建议

### 推荐参数设置
- **快速测试**: `--top 3` - 每个频道保留3个最快源，处理速度快
- **平衡设置**: `--top 5` - 每个频道保留5个源，质量与数量平衡
- **完整备份**: `--top 10` - 每个频道保留更多备用源

### 最佳实践
1. **首次运行**: 建议使用 `--top 3` 快速获得结果
2. **日常使用**: 推荐 `--top 5`，保证稳定性
3. **备份需求**: 使用 `--top 10` 获得更多备用源
4. **定期更新**: 建议每周运行一次，保持源的时效性

### 性能调优

```python
# 可以调整这些参数：
max_workers=3          # 并发线程数
timeout=8             # 单个测试超时
target_size=2MB       # 测试数据量
```

## 📄 许可证

MIT License - 详见LICENSE文件

## 🤝 贡献

欢迎提交Issue和Pull Request来改进这个工具！

## 📞 联系方式

如有问题或建议，请提交GitHub Issue。

---

⭐ 如果这个工具对你有帮助，请给个Star支持一下！
