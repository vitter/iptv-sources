# IPTV IP 搜索与测速综合工具

## 项目简介

IPTV IP 搜索与测速综合工具是一个集成化的Python应用程序，专门用于搜索、测试和评估IPTV服务器的性能。该工具整合了多个数据源和测试功能，为用户提供全面的IPTV服务器分析能力。

## 主要功能

### 🔍 多源IP搜索：使用FOFA和Quake360平台搜索指定地区运营商的udpxy服务器
- **FOFA搜索引擎**: 通过登录后Cookie 
- **Quake360搜索引擎**: 通过Quake360 API
- **智能查询构建**: 根据不同运营商自动构建最优查询条件

### 🌐 连通性检测
- **端口可达性测试**: 快速检测IP端口的连通状态
- **udpxy服务验证**: 验证目标服务器是否为有效的udpxy代理服务
- **并发测试**: 支持多线程并发测试，提高检测效率

### ⚡ 流媒体测速
- **直接流媒体下载**: 模拟真实播放环境进行速度测试
- **智能速度计算**: 精确计算平均下载速度
- **异常处理**: 完善的错误处理和超时控制机制

### 📊 结果管理
- **结果排序**: 按速度自动排序测试结果
- **文件生成**: 生成多种格式的结果文件
- **模板合并**: 支持与预定义模板文件合并

## 安装要求

### Python版本
- Python 3.6 或更高版本

### 依赖包
```bash
pip install requests urllib3 python-dotenv
```

### 系统要求
- Windows/Linux/macOS
- 网络连接
- 足够的磁盘空间用于临时文件

## 配置设置

### 环境变量配置

创建 `.env` 文件并设置以下配置项：

```env
# Quake360 API Token
QUAKE360_TOKEN=your_quake360_token_here

# FOFA 用户代理
FOFA_USER_AGENT=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36

# FOFA Cookie (登录后获取)
FOFA_COOKIE=your_fofa_cookie_string_here
```

### 省份配置文件

创建运营商特定的省份配置文件：
- `Telecom_province_list.txt`
- `Unicom_province_list.txt`
- `Mobile_province_list.txt`

配置文件格式：
```
Shanghai Shanghai rtp/225.1.8.1:8000
Beijing Beijing rtp/225.1.8.2:8000
Guangzhou Guangzhou rtp/225.1.8.3:8000
```

每行包含：`省份名称 城市名称 流媒体地址`

## 使用方法

### 基本语法
```bash
python speedtest_integrated_new.py <省市> <运营商>
```

### 支持的运营商
- `Telecom` - 中国电信
- `Unicom` - 中国联通
- `Mobile` - 中国移动

### 使用示例

```bash
# 测试上海电信
python speedtest_integrated_new.py Shanghai Telecom

# 测试北京联通
python speedtest_integrated_new.py Beijing Unicom

# 测试广州移动
python speedtest_integrated_new.py Guangzhou Mobile
```

## 输出文件说明

### 目录结构
```
sum/
├── tmp/                          # 临时文件目录
│   └── *_result_fofa_*.txt      # FOFA搜索结果
├── Telecom/                     # 电信结果目录
│   ├── *_sum.ip                 # 所有可访问IP
│   ├── *_uniq.ip               # 去重后的udpxy IP
│   └── *.txt                   # 最终结果文件
├── Unicom/                      # 联通结果目录
└── Mobile/                      # 移动结果目录

template/
├── Telecom/
│   └── template_*.txt          # 电信模板文件
├── Unicom/
└── Mobile/

*_speedtest_*.log               # 测速日志文件
```

### 结果文件格式

#### IP列表文件 (`*_uniq.ip`)
```
192.168.1.1:4022
192.168.1.2:4022
192.168.1.3:4022
```

#### 测速结果文件 (`*.txt`)
```
15.234  192.168.1.1:4022
12.156  192.168.1.2:4022
8.923   192.168.1.3:4022
```

#### 测速日志文件 (`*_speedtest_*.log`)
```
192.168.1.1:4022 15.234 MB/s Size:2097152
192.168.1.2:4022 12.156 MB/s Size:1048576
192.168.1.3:4022 8.923 MB/s Size:1572864
```

## 程序执行流程

1. **初始化阶段**
   - 加载环境变量配置
   - 验证必要参数
   - 创建输出目录
   - 读取省份配置

2. **IP搜索阶段**
   - FOFA平台搜索
   - Quake360平台搜索
   - 结果合并去重

3. **连通性测试阶段**
   - 端口可达性检测
   - udpxy服务验证
   - 生成可访问IP列表

4. **流媒体测速阶段**
   - 并发流媒体下载测试
   - 速度计算和记录
   - 异常处理

5. **结果生成阶段**
   - 结果排序筛选
   - 文件输出
   - 模板合并

6. **清理阶段**
   - 删除临时文件
   - 资源释放

## 性能特性

### 并发控制
- **搜索阶段**: 支持多平台并发搜索
- **连通性测试**: 最大30个并发连接
- **流媒体测速**: 最大3个并发下载（避免带宽竞争）

### 超时控制
- **端口测试**: 2秒超时
- **udpxy验证**: 5秒超时
- **流媒体下载**: 10秒超时或2MB限制

### 速度筛选
- **最低速度**: 0.1 MB/s
- **最高速度**: 1000 MB/s（异常检测）
- **下载限制**: 最大2MB或10秒

## 故障排除

### 常见问题

#### 1. 配置错误
**问题**: `错误: 缺少必要的环境变量配置`
**解决**: 检查 `.env` 文件是否存在且包含所有必需的配置项

#### 2. 搜索结果为空
**问题**: `FOFA搜索未找到任何IP`
**解决**: 
- 检查FOFA Cookie是否有效
- 验证搜索查询条件
- 确认网络连接正常

#### 3. 无可用IP
**问题**: `没有找到可用的udpxy服务器`
**解决**:
- 检查目标地区是否有相关服务
- 调整搜索条件或扩大搜索范围
- 验证网络防火墙设置

#### 4. 测速失败
**问题**: 所有IP测速都失败
**解决**:
- 检查流媒体地址配置
- 验证网络带宽
- 调整超时参数

### 日志调试

程序运行时会输出详细的调试信息，包括：
- 搜索查询条件
- IP发现数量
- 连通性测试结果
- 测速进度和结果
- 错误信息和异常

## 技术实现

### 核心技术
- **HTTP请求**: 使用requests库进行网络通信
- **并发处理**: ThreadPoolExecutor实现多线程并发
- **正则表达式**: 用于IP地址和端口号提取
- **Socket编程**: 底层网络连接测试

### 安全特性
- **用户代理伪装**: 模拟真实浏览器请求
- **请求重试**: 自动重试失败的网络请求
- **超时保护**: 防止程序无限期等待
- **异常处理**: 全面的错误捕获和处理

## 许可证

本项目采用开源许可证，具体许可证信息请查看LICENSE文件。

## 贡献指南

欢迎提交Issue和Pull Request来改进本项目：
1. Fork本项目
2. 创建特性分支
3. 提交更改
4. 发起Pull Request

## 联系方式

如有问题或建议，请通过以下方式联系：
- 提交GitHub Issue
- 发送邮件至项目维护者

---

**注意**: 使用本工具前请确保遵守相关网站的使用条款和法律法规。
