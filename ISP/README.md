# IPTV直播源按运营商分组工具 (isp.py)

## 功能说明

本工具基于 unicast.py 的逻辑，实现按视频源 URL 地址 IP 所在运营商进行分组的 IPTV 直播源处理功能。

### 主要特性

1. **下载直播源文件** - 从预定义的 URL 列表下载 txt 文件
2. **解析频道信息** - 提取频道名称和 URL
3. **流媒体测速** - 测试每个源的下载速度
4. **IP 地址解析** - 从 URL 中提取 IP 地址或域名
5. **运营商识别** - 通过 API 接口查询 IP 所属运营商
6. **两级分组** - 第一层按运营商分组，第二层按频道类型分组
7. **生成结果文件** - 输出 M3U 和 TXT 格式的播放列表

### 运营商分组

- **中国电信** - 通过 API 识别电信 IP 段
- **中国联通** - 通过 API 识别联通 IP 段  
- **中国移动** - 通过 API 识别移动 IP 段
- **中国铁通** - 通过 API 识别铁通 IP 段
- **教育网** - CERNET 教育网 IP 段
- **广电网络** - 广电的 IP 段
- **其他运营商** - 其他已知运营商
- **未知运营商** - 无法识别的 IP

### 频道类型分组

- **央视频道** - CCTV系列、CGTN等
- **卫视频道** - 各省卫视频道
- **港澳台频道** - 香港、澳门、台湾频道
- **省级频道** - 各省地方频道
- **市级频道** - 各市地方频道
- **其它频道** - 未分类的其他频道

### API 接口优化

1. **去重查询** - 对相同的 IP/域名只查询一次，避免重复请求
2. **多 API 支持** - 使用多个 IP 查询 API 提高成功率：
   - ip-api.com（支持 IP 和域名）
   - ipapi.co（仅支持 IP）
   - ipinfo.io（仅支持 IP）
3. **域名推测** - 当 API 查询失败时，根据域名特征推测运营商
4. **限流控制** - 使用较低的并发数避免 API 限制

## 安装依赖

```bash
pip install requests
```

## 使用方法

### 基本用法

```bash
# 使用默认设置，按运营商和频道类型两级分组（每个频道保留前20个最快源）
python isp.py

# 自定义保留源数量，按运营商和频道类型两级分组
python isp.py --top 10

# 仅按频道类型分组，不进行运营商分组（功能与unicast.py相同）
python isp.py --noisp

# 组合使用参数
python isp.py --top 15 --noisp
```

### 参数说明

- `--top N`: 每个频道最多保留速度最快的前 N 个 URL 源（默认: 20）
- `--noisp`: 不进行运营商分组，仅按频道类型分组（功能与unicast.py相同）

### 运行模式

#### 1. 正常模式（默认）
- 查询每个IP的运营商信息
- 按运营商和频道类型进行两级分组
- 输出文件名：`isp_result.m3u` 和 `isp_result.txt`

#### 2. noisp模式（--noisp）
- 跳过运营商查询，节省时间
- 仅按频道类型分组
- 输出文件名：`unicast_result.m3u` 和 `unicast_result.txt`
- 功能与unicast.py完全相同

## 输出文件

### 正常模式输出

#### 1. 播放列表文件

- `output/isp_result.m3u` - M3U 格式播放列表
  - 按运营商和频道类型两级分组
  - 显示运营商、下载速度等信息
  - 支持多源时显示源编号

- `output/isp_result.txt` - TXT 格式播放列表
  - 分组标题格式：`运营商-频道类型,#genre#`
  - 每行格式：`频道名称,流媒体地址`

### noisp模式输出（--noisp）

#### 1. 播放列表文件

- `output/unicast_result.m3u` - M3U 格式播放列表
  - 仅按频道类型分组
  - 显示下载速度等信息
  - 功能与unicast.py生成的文件相同

- `output/unicast_result.txt` - TXT 格式播放列表
  - 分组标题格式：`频道类型,#genre#`
  - 每行格式：`频道名称,流媒体地址`

### 2. 日志文件

- `isp_query.log` - 运营商查询日志（仅正常模式生成）
  - 格式：`频道名称 | IP地址 | 运营商 | 流媒体地址`
  - 记录所有查询结果
  - noisp模式下不会生成此文件

- `isp_speed.log` - 测速结果日志（两种模式都会生成）
  - 格式：`频道名称 | 下载速度(MB/s) | 流媒体地址`
  - 记录所有测速结果

- `isp_txt.tmp` - 汇总临时文件（两种模式都会生成）
  - 包含所有下载文件的合并内容

### 3. 目录结构

```
工作目录/
├── downloads/          # 下载的原始文件
├── output/            # 输出文件
│   ├── isp_result.m3u # M3U播放列表
│   └── isp_result.txt # TXT播放列表
├── isp_query.log      # 运营商查询日志
├── isp_speed.log      # 测速日志
└── isp_txt.tmp        # 临时汇总文件
```

## 工作流程

1. **下载源文件** - 并发下载所有 URL 的 txt 文件
2. **解析频道** - 提取频道名称和流媒体地址
3. **去重处理** - 基于频道名和 URL 去重
4. **流媒体测速** - 并发测试所有源的下载速度
5. **运营商查询** - 对测速成功的源进行运营商查询（去重）
6. **筛选源** - 每个频道保留速度最快的前 N 个源
7. **两级分组** - 按运营商和频道类型分组
8. **生成文件** - 输出 M3U 和 TXT 格式的播放列表

## 注意事项

1. **网络要求** - 需要能够访问运营商查询 API
2. **API 限制** - 工具已做限流处理，避免触发 API 限制
3. **测速精度** - 受网络环境影响，建议在网络较好时运行
4. **文件编码** - 所有输出文件使用 UTF-8 编码

## 与 unicast.py 的区别

1. **分组方式** - unicast.py 按频道类型分组，isp.py 按运营商和频道类型两级分组
2. **运营商识别** - isp.py 增加了运营商识别功能
3. **API 查询** - isp.py 使用在线 API 查询运营商信息
4. **查询优化** - isp.py 对相同 IP/域名去重查询，提高效率

## 故障排除

### 常见问题

1. **API 查询失败** - 检查网络连接，工具会自动尝试多个 API
2. **测速较慢** - 可以减少并发数或增加超时时间
3. **运营商识别不准确** - 部分 IP 可能识别为"其他运营商"或"未知运营商"

### 调试建议

1. 查看 `isp_query.log` 了解运营商查询情况
2. 查看 `isp_speed.log` 了解测速结果
3. 检查网络连接和防火墙设置
