# makecsv.py 四引擎集成完成说明

## 🎉 项目完成概览

Hotels/makecsv.py 已成功集成四个搜索引擎的支持，包括完整的时间参数处理和API字段映射验证。

## ✅ 已完成功能

### 1. 四引擎支持
- **FOFA API**: 原有功能增强，时间过滤使用 `after="YYYY-MM-DD"`
- **360 Quake API**: 新增支持，时间参数使用 `start_time/end_time` (YYYY-MM-DD HH:MM:SS)
- **ZoomEye API**: 新增支持，查询中添加 `&& after="YYYY-MM-DD"`
- **Hunter API**: 新增支持，时间参数使用 `start_time/end_time` (YYYY-MM-DD)

### 2. 时间参数处理
每个引擎都有独立的时间参数处理方法：
- `_get_date_filter(days)` - FOFA专用
- `_get_zoomeye_date_filter(days)` - ZoomEye专用
- `_get_quake360_time_range(days)` - 360 Quake专用
- `_get_hunter_time_range(days)` - Hunter专用

### 3. API字段映射验证
已验证所有四个引擎的API字段映射：
- 所有引擎字段提取方法已优化
- API响应结构已确认正确
- 数据标准化处理完成

### 4. 完整测试套件
- `test_four_engines.py` - 四引擎集成测试
- `validate_api_fields.py` - API字段映射验证
- `test_time_params.py` - 时间参数处理验证
- `test_functionality.py` - 功能完整性验证

## 🚀 使用方法

### 基本命令格式
```bash
python3 makecsv.py [选项]
```

### 支持的参数
- `--jsmpeg JSMPEG` - jsmpeg模式CSV文件路径
- `--txiptv TXIPTV` - txiptv模式CSV文件路径  
- `--zhgxtv ZHGXTV` - zhgxtv模式CSV文件路径
- `--days DAYS` - 日期过滤天数，默认30天
- `--region REGION` - 指定省份
- `--isp ISP` - 指定运营商 (Telecom/Unicom/Mobile)

### 使用示例
```bash
# 使用四引擎搜索河北电信的jsmpeg源，最近7天
python3 makecsv.py --jsmpeg jsmpeg.csv --days 7 --region Hebei --isp Telecom

# 使用四引擎搜索所有地区移动的txiptv源，最近30天
python3 makecsv.py --txiptv txiptv_new.csv --days 30 --isp Mobile

# 使用四引擎搜索广东联通的zhgxtv源，最近15天
python3 makecsv.py --zhgxtv zhgxtv_new.csv --days 15 --region Guangdong --isp Unicom
```

## 🔧 技术实现细节

### 时间参数处理策略
1. **FOFA**: 在查询字符串中添加 `after="YYYY-MM-DD"`
2. **ZoomEye**: 在查询字符串中添加 `&& after="YYYY-MM-DD"`  
3. **360 Quake**: 在API请求参数中添加 `start_time` 和 `end_time`
4. **Hunter**: 在API请求参数中添加 `start_time` 和 `end_time`

### API认证方式
- **FOFA**: Cookie + UserAgent 认证
- **360 Quake**: Token 认证 
- **ZoomEye**: API-KEY 认证
- **Hunter**: API-KEY 认证

### 数据去重机制
所有引擎的结果会自动去重，基于 IP:端口 组合进行唯一性检查。

## 📊 性能优化

### 并发处理
- 四个引擎并行搜索
- 分页请求优化
- 自动重试机制

### 错误处理
- API调用失败自动重试
- 无效数据自动过滤
- 详细错误日志记录

## 🔍 验证工具

### 快速验证
```bash
# 验证所有功能
python3 test_functionality.py

# 验证时间参数
python3 test_time_params.py

# 验证四引擎集成
python3 test_four_engines.py

# 验证API字段映射
python3 validate_api_fields.py
```

## 📝 配置要求

### API密钥配置
需要在 `config.ini` 中配置以下API密钥：
```ini
[FOFA]
email = your_email@example.com
key = your_fofa_key

[QUAKE360]
token = your_quake360_token

[ZOOMEYE]
api_key = your_zoomeye_api_key

[HUNTER]
api_key = your_hunter_api_key
```

## 🎯 使用建议

### 最佳实践
1. **时间范围**: 建议使用7-30天获得最佳性能
2. **地区筛选**: 指定具体省份可大幅提高搜索精度
3. **运营商筛选**: 结合地区和运营商筛选获得最准确结果
4. **批量处理**: 可以批量处理多个CSV文件

### 注意事项
- 确保API密钥有效且有足够配额
- 网络环境稳定，支持访问所有四个搜索引擎
- 建议在服务器环境中运行以获得最佳性能

## 🏆 项目成果

✅ **四引擎完全集成** - FOFA + 360 Quake + ZoomEye + Hunter  
✅ **时间参数全支持** - 所有引擎都支持按时间范围筛选  
✅ **API字段已验证** - 所有字段映射经过测试验证  
✅ **完整测试覆盖** - 全面的测试套件确保功能稳定  
✅ **生产环境就绪** - 可直接用于生产环境  

## 📞 技术支持

如需帮助，请参考测试脚本或运行验证工具进行问题诊断。
